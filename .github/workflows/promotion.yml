name: "Reusable: Promotion"

on:
  workflow_call:
    inputs:
      pipeline-kind:
        required: true
        type: string
        description: "single or multi"
      direction:
        required: true
        type: string
        description: "Promotion direction: test-to-uat or uat-to-main"
      system1-name:
        required: false
        type: string
        default: "Frontend-Root"
      system1-url:
        required: false
        type: string
        default: ""
      system2-name:
        required: false
        type: string
        default: ""
      system2-url:
        required: false
        type: string
        default: ""
      system3-name:
        required: false
        type: string
        default: ""
      system3-url:
        required: false
        type: string
        default: ""
      version-tag:
        required: false
        type: string
        default: ""
      versions-json:
        required: false
        type: string
        default: "{}"
      systems-json:
        required: false
        type: string
        default: ""
      deployment-urls-json:
        required: false
        type: string
        default: "{}"
      results-json:
        required: false
        type: string
        default: "{}"
      dry-run:
        required: false
        type: boolean
        default: false
      system1-result:
        required: false
        type: string
        default: ""
      system2-result:
        required: false
        type: string
        default: ""
      system3-result:
        required: false
        type: string
        default: ""
      tests-status:
        required: false
        type: string
        default: ""
      lint-status:
        required: false
        type: string
        default: ""
      security-status:
        required: false
        type: string
        default: ""
      sonar-status:
        required: false
        type: string
        default: ""
      pipeline-result:
        required: false
        type: string
        default: ""
    secrets:
      PR_TOKEN:
        required: true

jobs:
  promote:
    name: "Create Promotion PR"
    runs-on: ubuntu-latest
    steps:
      - name: Validate PAT for PR creation
        env:
          PR_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          if [ -z "${PR_TOKEN}" ]; then
            echo "âŒ Missing PAT secret for PR creation."
            echo "Provide PR_TOKEN when calling this workflow."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PR_TOKEN }}

      - name: Create promotion PR
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          PIPELINE_KIND: ${{ inputs.pipeline-kind }}
          DIRECTION: ${{ inputs.direction }}
          SYSTEM1_NAME: ${{ inputs.system1-name }}
          SYSTEM1_URL: ${{ inputs.system1-url }}
          SYSTEM2_NAME: ${{ inputs.system2-name }}
          SYSTEM2_URL: ${{ inputs.system2-url }}
          SYSTEM3_NAME: ${{ inputs.system3-name }}
          SYSTEM3_URL: ${{ inputs.system3-url }}
          SYSTEM1_RESULT: ${{ inputs.system1-result }}
          SYSTEM2_RESULT: ${{ inputs.system2-result }}
          SYSTEM3_RESULT: ${{ inputs.system3-result }}
          SYSTEMS_JSON_INPUT: ${{ inputs.systems-json }}
          DEPLOYMENT_URLS_JSON_INPUT: ${{ inputs.deployment-urls-json }}
          RESULTS_JSON_INPUT: ${{ inputs.results-json }}
          VERSION_TAG_INPUT: ${{ inputs.version-tag }}
          VERSIONS_JSON_INPUT: ${{ inputs.versions-json }}
          DRY_RUN: ${{ inputs.dry-run }}
          TESTS_STATUS_INPUT: ${{ inputs.tests-status }}
          LINT_STATUS_INPUT: ${{ inputs.lint-status }}
          SECURITY_STATUS_INPUT: ${{ inputs.security-status }}
          SONAR_STATUS_INPUT: ${{ inputs.sonar-status }}
          PIPELINE_RESULT_INPUT: ${{ inputs.pipeline-result }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          SHORT_SHA="${GITHUB_SHA:0:7}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          VERSION_TAG="${VERSION_TAG_INPUT}"

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            SOURCE_BRANCH="test"
            TARGET_BRANCH="uat"
            TITLE="ðŸš€ Release: Promote TEST â†’ UAT (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote TEST â†’ UAT"
            CONTEXT_LABEL="TEST"
            FOOTER="*Merge this PR to trigger UAT deployment.*"
            INTRO="This PR was **automatically created** after all CI checks and TEST deployments passed on the \`test\` branch."

            if [ "${PIPELINE_KIND}" = "single" ] && { [ -z "${VERSION_TAG}" ] || [ "${VERSION_TAG}" = "test-v" ]; }; then
              VERSION_TAG=$(git tag -l 'test-v*' | grep -E '^test-v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            fi
            if [ "${PIPELINE_KIND}" = "single" ] && [ -z "${VERSION_TAG}" ]; then
              echo "âŒ Unable to resolve TEST version tag for PR body."
              exit 1
            fi
          elif [ "${DIRECTION}" = "uat-to-main" ]; then
            SOURCE_BRANCH="uat"
            TARGET_BRANCH="main"
            TITLE="ðŸš€ Release: Promote UAT â†’ Production (${SHORT_SHA})"
            HEADER="## ðŸš€ Promote UAT â†’ Production"
            CONTEXT_LABEL="UAT"
            FOOTER="*Merge this PR to deploy to production. A production readiness gate will run automatically.*"
            INTRO="This PR was **automatically created** after all CI checks and UAT deployments passed on the \`uat\` branch."

            if [ "${PIPELINE_KIND}" = "single" ] && [ -z "${VERSION_TAG}" ]; then
              VERSION_TAG=$(git tag -l 'test-v*' | grep -E '^test-v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
            fi
          else
            echo "âŒ Invalid direction: ${DIRECTION}. Expected test-to-uat or uat-to-main."
            exit 1
          fi

          COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${TARGET_BRANCH}...${SOURCE_BRANCH}"

          EXISTING_PR=$(gh pr list --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --state open --json number --jq '.[0].number' 2>/dev/null || true)

          if [ -n "${SYSTEMS_JSON_INPUT}" ]; then
            SYSTEMS_JSON="${SYSTEMS_JSON_INPUT}"
          else
            SYSTEMS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" \
              --arg n2 "${SYSTEM2_NAME}" \
              --arg n3 "${SYSTEM3_NAME}" \
              '[
                {name:$n1},
                {name:$n2},
                {name:$n3}
              ] | map(select(.name != ""))')
          fi

          if ! echo "${SYSTEMS_JSON}" | jq -e . >/dev/null 2>&1; then
            echo "âŒ Invalid systems-json payload."
            exit 1
          fi

          if [ "$(echo "${SYSTEMS_JSON}" | jq 'length')" -eq 0 ]; then
            echo "âŒ No systems provided for promotion PR body."
            exit 1
          fi

          if [ -n "${DEPLOYMENT_URLS_JSON_INPUT}" ] && echo "${DEPLOYMENT_URLS_JSON_INPUT}" | jq -e . >/dev/null 2>&1 && [ "$(echo "${DEPLOYMENT_URLS_JSON_INPUT}" | jq 'length')" -gt 0 ]; then
            DEPLOYMENT_URLS_JSON="${DEPLOYMENT_URLS_JSON_INPUT}"
          else
            DEPLOYMENT_URLS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" --arg u1 "${SYSTEM1_URL}" \
              --arg n2 "${SYSTEM2_NAME}" --arg u2 "${SYSTEM2_URL}" \
              --arg n3 "${SYSTEM3_NAME}" --arg u3 "${SYSTEM3_URL}" \
              '{($n1):$u1, ($n2):$u2, ($n3):$u3}')

            if [ "$(echo "${DEPLOYMENT_URLS_JSON}" | jq '[to_entries[] | select(.key != "" and .value != "")] | length')" -eq 0 ]; then
              RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              DEPLOYMENT_URLS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --arg runUrl "${RUN_URL}" 'reduce .[] as $s ({}; .[$s.name] = $runUrl)')
            fi
          fi

          if [ -n "${RESULTS_JSON_INPUT}" ] && echo "${RESULTS_JSON_INPUT}" | jq -e . >/dev/null 2>&1 && [ "$(echo "${RESULTS_JSON_INPUT}" | jq 'length')" -gt 0 ]; then
            RESULTS_JSON="${RESULTS_JSON_INPUT}"
          else
            RESULTS_JSON=$(jq -nc \
              --arg n1 "${SYSTEM1_NAME}" --arg r1 "${SYSTEM1_RESULT}" \
              --arg n2 "${SYSTEM2_NAME}" --arg r2 "${SYSTEM2_RESULT}" \
              --arg n3 "${SYSTEM3_NAME}" --arg r3 "${SYSTEM3_RESULT}" \
              '{($n1):$r1, ($n2):$r2, ($n3):$r3}')

            if [ "$(echo "${RESULTS_JSON}" | jq '[to_entries[] | select(.key != "" and .value != "")] | length')" -eq 0 ]; then
              DEFAULT_RESULT="${SYSTEM1_RESULT}"
              if [ -z "${DEFAULT_RESULT}" ]; then
                DEFAULT_RESULT="success"
              fi
              RESULTS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --arg value "${DEFAULT_RESULT}" 'reduce .[] as $s ({}; .[$s.name] = $value)')
            fi
          fi

          if [ -n "${VERSIONS_JSON_INPUT}" ] && echo "${VERSIONS_JSON_INPUT}" | jq -e . >/dev/null 2>&1 && [ "$(echo "${VERSIONS_JSON_INPUT}" | jq 'length')" -gt 0 ]; then
            VERSIONS_JSON="${VERSIONS_JSON_INPUT}"
          else
            VERSIONS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --arg version "${VERSION_TAG}" 'reduce .[] as $s ({}; .[$s.name] = $version)')
          fi

            if [ "${PIPELINE_KIND}" = "single" ]; then
              if [ -z "${SYSTEM1_NAME}" ]; then
                echo "âŒ system1-name is required for single pipeline-kind."
                exit 1
              fi
              SYSTEMS_JSON=$(jq -nc --arg n1 "${SYSTEM1_NAME}" '[{name:$n1}]')
            fi

            RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            DEFAULT_RESULT="${SYSTEM1_RESULT}"
            if [ -z "${DEFAULT_RESULT}" ]; then
              DEFAULT_RESULT="success"
            fi

            TESTS_STATUS="${TESTS_STATUS_INPUT}"
            LINT_STATUS="${LINT_STATUS_INPUT}"
            SECURITY_STATUS="${SECURITY_STATUS_INPUT}"
            SONAR_STATUS="${SONAR_STATUS_INPUT}"
            PIPELINE_RESULT="${PIPELINE_RESULT_INPUT}"

            if [ -z "${TESTS_STATUS}" ]; then TESTS_STATUS="${DEFAULT_RESULT}"; fi
            if [ -z "${LINT_STATUS}" ]; then LINT_STATUS="${DEFAULT_RESULT}"; fi
            if [ -z "${SECURITY_STATUS}" ]; then SECURITY_STATUS="${DEFAULT_RESULT}"; fi
            if [ -z "${SONAR_STATUS}" ]; then SONAR_STATUS="${DEFAULT_RESULT}"; fi
            if [ -z "${PIPELINE_RESULT}" ]; then PIPELINE_RESULT="${DEFAULT_RESULT}"; fi

            DEPLOYMENT_URLS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --argjson urls "${DEPLOYMENT_URLS_JSON}" --arg runUrl "${RUN_URL}" '
              reduce .[] as $s ({};
                .[$s.name] = ((($urls[$s.name] // "") | tostring) | if length > 0 then . else $runUrl end)
              )')

            RESULTS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --argjson results "${RESULTS_JSON}" --arg defaultResult "${DEFAULT_RESULT}" '
              reduce .[] as $s ({};
                .[$s.name] = ((($results[$s.name] // "") | tostring) | if length > 0 then . else $defaultResult end)
              )')

            VERSIONS_JSON=$(echo "${SYSTEMS_JSON}" | jq -c --argjson versions "${VERSIONS_JSON}" --arg defaultVersion "${VERSION_TAG}" '
              reduce .[] as $s ({};
                .[$s.name] = ((($versions[$s.name] // "") | tostring) | if length > 0 then . else (if ($defaultVersion | length) > 0 then $defaultVersion else "N/A" end) end)
              )')

          CHECKLIST=$(echo "${SYSTEMS_JSON}" | jq -r --arg label "${CONTEXT_LABEL}" 'map("- [ ] Verified \(.name) on \($label)") | join("\n")')
          ROWS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson urls "${DEPLOYMENT_URLS_JSON}" --arg runUrl "${RUN_URL}" '
            .[]
            | (($urls[.name] // "") | tostring) as $raw
            | (if ($raw | length) > 0 then $raw else $runUrl end) as $url
            | "| \(.name) | [Open deployment](" + $url + ") |"
          ')

          if [ "${DIRECTION}" = "test-to-uat" ]; then
            CHECKLIST+=$'\n- [ ] Ready for UAT validation'
          else
            CHECKLIST+=$'\n- [ ] All acceptance criteria met'
          fi

          AVAILABLE_LINKS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson urls "${DEPLOYMENT_URLS_JSON}" --arg runUrl "${RUN_URL}" '
            [.[]
              | (($urls[.name] // "") | tostring) as $raw
              | (if ($raw | length) > 0 then $raw else $runUrl end)
              | select(length > 0)
            ] | length
          ')

          EVIDENCE_ROWS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson results "${RESULTS_JSON}" --arg defaultResult "${DEFAULT_RESULT}" '.[] | "| CI â€” \(.name) | " + ((($results[.name] // "") | tostring) | if length > 0 then . else $defaultResult end) + " |"')
          EVIDENCE_ROWS=$(printf "%s\n| Deployment Links | %s available |" "${EVIDENCE_ROWS}" "${AVAILABLE_LINKS}")
          VERSION_ROWS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson versions "${VERSIONS_JSON}" '.[] | "| Version â€” \(.name) | " + ((($versions[.name] // "") | tostring) | if length > 0 then . else "N/A" end) + " |"')
          EVIDENCE_ROWS=$(printf "%s\n%s" "${EVIDENCE_ROWS}" "${VERSION_ROWS}")

          RELEASE_VERSION_VALUE="${VERSION_TAG:-N/A}"
          if [ "${PIPELINE_KIND}" = "multi" ]; then
            RELEASE_VERSION_VALUE="Per-system (see Evidence)"
          fi

          RELEASE_SUMMARY=$(printf -- "| Metric | Value |\n|--------|-------|\n| Version Tag | %s |\n| Short SHA | %s |\n| Compare | [View changes](%s) |\n| Pipeline Result | %s |" "${RELEASE_VERSION_VALUE}" "${SHORT_SHA}" "${COMPARE_URL}" "${PIPELINE_RESULT}")
          QUALITY_GATES=$(printf -- "| Gate | Status |\n|------|--------|\n| Tests | %s |\n| Lint | %s |\n| Security | %s |\n| Sonar | %s |" "${TESTS_STATUS}" "${LINT_STATUS}" "${SECURITY_STATUS}" "${SONAR_STATUS}")

          DETAILS=$(printf -- "- **Source branch:** %s\n- **Target branch:** %s" "${SOURCE_BRANCH}" "${TARGET_BRANCH}")
          if [ "${PIPELINE_KIND}" = "multi" ]; then
            VERSION_DETAILS=$(echo "${SYSTEMS_JSON}" | jq -r --argjson versions "${VERSIONS_JSON}" '.[] | "  - **" + .name + "**: `" + (((($versions[.name] // "") | tostring) | if length > 0 then . else "N/A" end)) + "`"')
            DETAILS=$(printf "%s\n- **Version tags per system:**\n%s" "${DETAILS}" "${VERSION_DETAILS}")
          else
            DETAILS=$(printf "%s\n- **Version tag:** \`%s\`" "${DETAILS}" "${VERSION_TAG:-N/A}")
          fi
          DETAILS=$(printf "%s\n- **Commit:** \`%s\`\n- **Compare:** [View changes](%s)\n- **Triggered at:** %s\n- **Pipeline run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" "${DETAILS}" "${SHORT_SHA}" "${COMPARE_URL}" "${TIMESTAMP}")

          PR_BODY=$(cat <<ENDOFBODY
          ${HEADER}

          ${INTRO}

          ### ðŸ“‹ Pre-merge Checklist
          ${CHECKLIST}

          ### ðŸ”— Vercel ${CONTEXT_LABEL} Deployment Links
          | System | ${CONTEXT_LABEL} Preview Link |
          |--------|------------------|
          ${ROWS}

          ### âœ… Evidence
          | Check | Status |
          |-------|--------|
          ${EVIDENCE_ROWS}

          ### ðŸ§¾ Release Summary
          ${RELEASE_SUMMARY}

          ### ðŸ›¡ï¸ Quality Gates
          ${QUALITY_GATES}

          ### ðŸ” Details
          ${DETAILS}

          ---
          ${FOOTER}
          ENDOFBODY
          )

          if [ "${DRY_RUN}" = "true" ]; then
            echo "ðŸ§ª Dry run enabled. PR body preview:"
            echo "${PR_BODY}"
            exit 0
          fi

          if [ -n "${EXISTING_PR}" ]; then
            retry 3 3 gh pr edit "${EXISTING_PR}" --body "${PR_BODY}"
            echo "âœ… Updated PR #${EXISTING_PR}: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
            exit 0
          fi

          retry 3 3 gh pr create --base "${TARGET_BRANCH}" --head "${SOURCE_BRANCH}" --title "${TITLE}" --body "${PR_BODY}"
          echo "âœ… Created PR: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
