# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  REUSABLE: Deploy to Environment                               ‚ïë
# ‚ïë  Supports web (Vercel), API (container), and mobile (APK)     ‚ïë
# ‚ïë  Deploys to: test | uat | prod (staging/preprod)              ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
name: "Reusable: Deploy to Environment"

on:
  workflow_call:
    inputs:
      system-dir:
        required: false
        type: string
        default: "."
        description: "System directory name"
      system-name:
        required: true
        type: string
        description: "System name for artifacts/display"
      app-type:
        required: true
        type: string
        description: "Application type (web|api|mobile)"
      artifact-name:
        required: true
        type: string
        description: "Artifact name to download"
      deploy-environment:
        required: false
        type: string
        default: "uat"
        description: "Target environment (test|uat|prod)"
      staging-url:
        required: false
        type: string
        default: ""
        description: "Expected URL for health check"
      enable-health-check:
        required: false
        type: boolean
        default: true
        description: "Run post-deploy health check"
    outputs:
      deployment-url:
        description: "Deployment URL"
        value: ${{ jobs.deploy.outputs.url }}
      deployment-status:
        description: "Deployment status"
        value: ${{ jobs.deploy.outputs.status }}

permissions:
  contents: read

jobs:
  deploy:
    name: "Deploy to ${{ inputs.deploy-environment }}"
    runs-on: ubuntu-latest
    timeout-minutes: 40
    environment:
      name: ${{ inputs.deploy-environment }}
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      status: ${{ steps.deploy.outputs.status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ./build

      - name: Deploy to ${{ inputs.deploy-environment }}
        id: deploy
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë   DEPLOYMENT ‚Äî ${{ inputs.deploy-environment }}                       ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë System:      ${{ inputs.system-name }}"
          echo "‚ïë Type:        ${{ inputs.app-type }}"
          echo "‚ïë Environment: ${{ inputs.deploy-environment }}"
          echo "‚ïë Branch:      ${{ github.ref_name }}"
          echo "‚ïë Commit:      ${{ github.sha }}"
          echo "‚ïë Timestamp:   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

          ENV="${{ inputs.deploy-environment }}"

          # Route deployment by app type
          case "${{ inputs.app-type }}" in
            web)
              echo "üåê Deploying web app to ${ENV}..."
              echo "url=https://${{ inputs.system-name }}-${ENV}.vercel.app" >> $GITHUB_OUTPUT
              ;;
            api)
              echo "‚öôÔ∏è Deploying backend API to ${ENV}..."
              echo "url=https://${{ inputs.system-name }}-${ENV}.api.example.com" >> $GITHUB_OUTPUT
              ;;
            mobile)
              echo "üì± Publishing mobile APK to ${ENV}..."
              echo "url=https://github.com/${{ github.repository }}/releases" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment to ${ENV} completed"

      - name: Post-Deploy Health Check
        if: ${{ inputs.enable-health-check && inputs.staging-url != '' }}
        run: |
          echo "üè• Running health check on ${{ inputs.staging-url }}..."
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ inputs.staging-url }}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed (attempt $i)"
              exit 0
            fi
            echo "‚è≥ Attempt $i: Status $STATUS ‚Äî retrying in 10s..."
            sleep 10
          done
          echo "‚ùå Health check failed after 5 attempts"
          exit 1

      - name: Create Deployment Log
        if: always()
        run: |
          cat << EOF > deployment-log.json
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "system": "${{ inputs.system-name }}",
            "app_type": "${{ inputs.app-type }}",
            "environment": "${{ inputs.deploy-environment }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_by": "${{ github.actor }}",
            "status": "${{ steps.deploy.outputs.status }}",
            "url": "${{ steps.deploy.outputs.url }}",
            "run_id": "${{ github.run_id }}"
          }
          EOF
          cat deployment-log.json

      - name: Upload Deployment Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.system-name }}-${{ inputs.deploy-environment }}-deployment-log
          path: deployment-log.json
          retention-days: 90
