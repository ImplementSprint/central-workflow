# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë  REUSABLE: Vercel Deployment                                   ‚ïë
# ‚ïë  Handles UAT (preview) and Production deploys                 ‚ïë
# ‚ïë  Monorepo: each sub-project has its own VERCEL_PROJECT_ID     ‚ïë
# ‚ïë                                                                ‚ïë
# ‚ïë  Required repo secrets (per sub-project):                     ‚ïë
# ‚ïë    VERCEL_TOKEN              ‚Äî shared Vercel API token         ‚ïë
# ‚ïë    VERCEL_ORG_ID             ‚Äî shared Vercel Org/Team ID      ‚ïë
# ‚ïë    VERCEL_PROJECT_ID_BAYANIHUB_WEB                            ‚ïë
# ‚ïë    VERCEL_PROJECT_ID_DAMAYAN_WEB                              ‚ïë
# ‚ïë    VERCEL_PROJECT_ID_HOPECARD_WEB                             ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
name: "Reusable: Vercel Deploy"

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
        description: "Project directory (e.g. BayaniHub-Web)"
      environment:
        required: false
        type: string
        default: "preview"
        description: "Deployment environment (preview|production)"
    secrets:
      VERCEL_TOKEN:
        required: true
      VERCEL_ORG_ID:
        required: true
      VERCEL_PROJECT_ID:
        required: true
    outputs:
      deployment_url:
        description: "Vercel deployment URL"
        value: ${{ jobs.vercel-deploy.outputs.url }}
      deployment_id:
        description: "Vercel deployment ID"
        value: ${{ jobs.vercel-deploy.outputs.id }}

jobs:
  vercel-deploy:
    name: "Deploy to Vercel (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      id: ${{ steps.deploy.outputs.id }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Project Directory
        run: |
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json not found in ./${{ inputs.working-directory }}"
            echo "This usually means Vercel Root Directory is misconfigured for this project."
            echo "Set Vercel Root Directory to '.' for this linked sub-project context."
            exit 1
          fi
        working-directory: ./${{ inputs.working-directory }}

      - name: Install Vercel CLI
        run: npm install -g vercel@50.22.1

      - name: Pull and Build with Vercel (adaptive context)
        id: prepare
        run: |
          set -uo pipefail

          run_pull_build() {
            local dir="$1"
            echo "üîé Trying Vercel pull/build in: $dir"

            pushd "$dir" > /dev/null

            vercel pull --yes --environment=${{ inputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
            local pull_status=$?
            if [ $pull_status -ne 0 ]; then
              echo "‚ùå vercel pull failed in $dir"
              popd > /dev/null
              return 1
            fi

            if [ "${{ inputs.environment }}" = "production" ]; then
              vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
            else
              vercel build --token=${{ secrets.VERCEL_TOKEN }}
            fi
            local build_status=$?
            if [ $build_status -ne 0 ]; then
              echo "‚ùå vercel build failed in $dir"
              popd > /dev/null
              return 1
            fi

            if [ ! -d ".vercel/output" ]; then
              echo "‚ùå .vercel/output not found in $dir"
              popd > /dev/null
              return 1
            fi

            popd > /dev/null
            return 0
          }

          if run_pull_build "./${{ inputs.working-directory }}"; then
            echo "deploy_dir=./${{ inputs.working-directory }}" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Using deploy directory: ./${{ inputs.working-directory }}"
          elif run_pull_build "."; then
            echo "deploy_dir=." >> "$GITHUB_OUTPUT"
            echo "‚úÖ Using deploy directory: ."
          else
            echo "‚ùå Vercel pull/build failed in both contexts."
            echo "Check VERCEL_PROJECT_ID mapping and Root Directory in Vercel project settings."
            exit 1
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"

          if [ "${{ inputs.environment }}" = "production" ]; then
            DEPLOY_OUTPUT=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} --meta githubCommitRef="${BRANCH_NAME}" --meta githubCommitSha="${GITHUB_SHA}" 2>&1)
          else
            DEPLOY_OUTPUT=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} --meta githubCommitRef="${BRANCH_NAME}" --meta githubCommitSha="${GITHUB_SHA}" 2>&1)
          fi

          URL=$(echo "${DEPLOY_OUTPUT}" | grep -Eo 'https://[^[:space:]]+' | tail -n 1 | tr -d '\r')

          if [ -z "${URL}" ]; then
            echo "‚ùå Failed to extract deployment URL from Vercel output."
            echo "${DEPLOY_OUTPUT}"
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "üöÄ Deployed to: $URL"
        working-directory: ${{ steps.prepare.outputs.deploy_dir }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Cleanup previous branch preview deployments
        if: ${{ inputs.environment == 'preview' }}
        run: |
          set -euo pipefail

          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          CURRENT_URL="${{ steps.deploy.outputs.url }}"

          if [ -z "${CURRENT_URL}" ]; then
            echo "‚ö†Ô∏è Current deployment URL is empty; skipping cleanup."
            exit 0
          fi

          API_URL="https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&target=preview&meta-githubCommitRef=${BRANCH_NAME}&limit=100"
          RESPONSE=$(curl -sS -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "${API_URL}")

          if ! echo "${RESPONSE}" | jq -e . >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Invalid response from Vercel API; skipping cleanup."
            exit 0
          fi

          OLD_URLS=$(echo "${RESPONSE}" | jq -r --arg current "${CURRENT_URL}" '
            [.deployments[]?
              | select((.state // "") == "READY")
              | select((.url // "") != "")
              | ("https://" + .url)
              | select(. != $current)
            ] | unique | .[]
          ')

          if [ -z "${OLD_URLS}" ]; then
            echo "‚ÑπÔ∏è No previous preview deployments found for branch '${BRANCH_NAME}'."
            exit 0
          fi

          echo "üßπ Removing previous preview deployments for branch '${BRANCH_NAME}'..."
          while IFS= read -r OLD_URL; do
            if [ -n "${OLD_URL}" ]; then
              echo "- Removing ${OLD_URL}"
              vercel remove "${OLD_URL}" --yes --token=${{ secrets.VERCEL_TOKEN }} || echo "‚ö†Ô∏è Failed to remove ${OLD_URL}; continuing."
            fi
          done <<< "${OLD_URLS}"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Comment Deployment URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const body = `## üöÄ Vercel Preview Deployment\n\n` +
              `**Project:** \`${{ inputs.working-directory }}\`\n` +
              `**Environment:** \`${{ inputs.environment }}\`\n` +
              `**URL:** ${url}\n` +
              `**Commit:** \`${{ github.sha }}\``;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
