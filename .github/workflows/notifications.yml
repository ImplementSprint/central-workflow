# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  REUSABLE: Pipeline Notifications                              â•‘
# â•‘  Sends failure/success alerts to configured channels          â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "Reusable: Pipeline Notifications"

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string
        description: "Pipeline status (success|failure|cancelled)"
      system-dir:
        required: true
        type: string
        description: "System name or comma-separated system names"
      pipeline-type:
        required: false
        type: string
        default: "CI/CD"
        description: "Pipeline type (CI/CD, Staging, Production)"
      error-details:
        required: false
        type: string
        default: ""
        description: "Error details for failure notifications"
      deployment-url:
        required: false
        type: string
        default: ""
        description: "Deployment URL to include when available"
      deployment-urls-json:
        required: false
        type: string
        default: "{}"
        description: "Deployment URLs by system as JSON object"
      success-image-url:
        required: false
        type: string
        default: ""
        description: "Discord image URL shown when status=success"
      failure-image-url:
        required: false
        type: string
        default: ""
        description: "Discord image URL shown when status=failure"
      cancelled-image-url:
        required: false
        type: string
        default: ""
        description: "Discord image URL shown when status=cancelled"
    secrets:
      SLACK_WEBHOOK_URL:
        required: false
      DISCORD_WEBHOOK_URL:
        required: false

jobs:
  notify:
    name: "Send Notification"
    runs-on: ubuntu-latest
    env:
      HAS_SLACK: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      HAS_DISCORD: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
    steps:
      - name: Prepare Notification
        id: prepare
        env:
          STATUS: ${{ inputs.status }}
          SYSTEM_DIR: ${{ inputs['system-dir'] }}
          PIPELINE_TYPE: ${{ inputs['pipeline-type'] }}
          BRANCH_NAME: ${{ github.ref_name }}
          ACTOR_NAME: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
          SHORT_SHA: ${{ github.sha }}
          WORKFLOW_NAME: ${{ github.workflow }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          EVENT_NAME: ${{ github.event_name }}
          BEFORE_SHA: ${{ github.event.before }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMPARE_DEFAULT: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SUCCESS_IMAGE_URL: ${{ inputs['success-image-url'] }}
          FAILURE_IMAGE_URL: ${{ inputs['failure-image-url'] }}
          CANCELLED_IMAGE_URL: ${{ inputs['cancelled-image-url'] }}
        run: |
          SHORT_SHA="${COMMIT_SHA:0:7}"

          if [ "${EVENT_NAME}" = "push" ] && [ -n "${BEFORE_SHA}" ] && [ "${BEFORE_SHA}" != "0000000000000000000000000000000000000000" ]; then
            COMPARE_URL="${{ github.server_url }}/${{ github.repository }}/compare/${BEFORE_SHA}...${COMMIT_SHA}"
          else
            COMPARE_URL="${COMPARE_DEFAULT}"
          fi

          case "${BRANCH_NAME}" in
            main)
              ENV_LABEL="Production"
              ENV_EMOJI="ğŸ"
              ENV_COLOR="15548997"
              ;;
            uat)
              ENV_LABEL="UAT"
              ENV_EMOJI="ğŸ§ª"
              ENV_COLOR="15844367"
              ;;
            test)
              ENV_LABEL="Test"
              ENV_EMOJI="ğŸ”¬"
              ENV_COLOR="5793266"
              ;;
            *)
              ENV_LABEL="${BRANCH_NAME}"
              ENV_EMOJI="ğŸŒ¿"
              ENV_COLOR="10181046"
              ;;
          esac

          if [ "${STATUS}" = "success" ]; then
            EMOJI="âœ…"
            COLOR="good"
            TITLE="Pipeline Succeeded"
          elif [ "${STATUS}" = "failure" ]; then
            EMOJI="âŒ"
            COLOR="danger"
            TITLE="Pipeline Failed"
          else
            EMOJI="âš ï¸"
            COLOR="warning"
            TITLE="Pipeline Cancelled"
          fi

          if [ "${STATUS}" = "failure" ] && { [ "${BRANCH_NAME}" = "main" ] || [ "${BRANCH_NAME}" = "uat" ]; }; then
            MENTION="<!here>"
          else
            MENTION=""
          fi

          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "env_color=$ENV_COLOR" >> $GITHUB_OUTPUT
          echo "env_label=$ENV_LABEL" >> $GITHUB_OUTPUT
          echo "env_emoji=$ENV_EMOJI" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "mention=$MENTION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "run_attempt=$RUN_ATTEMPT" >> $GITHUB_OUTPUT
          echo "compare_url=$COMPARE_URL" >> $GITHUB_OUTPUT

          IMAGE_URL=""
          if [ "${STATUS}" = "success" ]; then
            IMAGE_URL="${SUCCESS_IMAGE_URL}"
          elif [ "${STATUS}" = "failure" ]; then
            IMAGE_URL="${FAILURE_IMAGE_URL}"
          else
            IMAGE_URL="${CANCELLED_IMAGE_URL}"
          fi

          # Convert common Google Drive share links to direct-view links for Discord embeds.
          DRIVE_ID=""
          if echo "${IMAGE_URL}" | grep -Eq '^https://drive\.google\.com/file/d/[^/]+/view'; then
            DRIVE_ID=$(echo "${IMAGE_URL}" | sed -E 's#^https://drive\.google\.com/file/d/([^/]+)/view.*#\1#')
          elif echo "${IMAGE_URL}" | grep -Eq '^https://drive\.google\.com/open\?id='; then
            DRIVE_ID=$(echo "${IMAGE_URL}" | sed -E 's#^https://drive\.google\.com/open\?id=([^&]+).*$#\1#')
          elif echo "${IMAGE_URL}" | grep -Eq '^https://drive\.google\.com/uc\?id='; then
            DRIVE_ID=$(echo "${IMAGE_URL}" | sed -E 's#^https://drive\.google\.com/uc\?id=([^&]+).*$#\1#')
          fi

          if [ -n "${DRIVE_ID}" ]; then
            IMAGE_URL="https://drive.google.com/uc?export=view&id=${DRIVE_ID}"
          fi

          echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT

          echo "$EMOJI $TITLE"
          echo "  Systems:  ${SYSTEM_DIR}"
          echo "  Pipeline: ${PIPELINE_TYPE}"
          echo "  Branch:   ${BRANCH_NAME}"
          echo "  Commit:   ${COMMIT_SHA}"
          echo "  Actor:    ${ACTOR_NAME}"
          echo "  Run URL:  ${RUN_URL}"

      - name: Notify Slack
        if: env.HAS_SLACK == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          retry 3 3 curl -sS -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg mention '${{ steps.prepare.outputs.mention }}' \
              --arg color '${{ steps.prepare.outputs.color }}' \
              --arg title '${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.title }}' \
              --arg systems '${{ inputs['system-dir'] }}' \
              --arg pipeline '${{ inputs['pipeline-type'] }}' \
              --arg branch '${{ github.ref_name }}' \
              --arg actor '${{ github.actor }}' \
              --arg workflow '${{ steps.prepare.outputs.workflow_name }}' \
              --arg attempt '${{ steps.prepare.outputs.run_attempt }}' \
              --arg shortSha '${{ steps.prepare.outputs.short_sha }}' \
              --arg compareUrl '${{ steps.prepare.outputs.compare_url }}' \
              --arg runUrl '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}' \
              --arg envLabel '${{ steps.prepare.outputs.env_emoji }} ${{ steps.prepare.outputs.env_label }}' \
              --arg deploymentUrl '${{ inputs['deployment-url'] }}' \
              --arg deploymentUrlsJson '${{ inputs['deployment-urls-json'] }}' \
              --arg details '${{ inputs['error-details'] }}' \
              '((try ($deploymentUrlsJson | fromjson) catch {}) | to_entries | map(select((.key | length) > 0 and ((.value | tostring) | length) > 0))) as $deploymentEntries |
              ($deploymentEntries | map("â€¢ " + .key + ": " + (.value | tostring)) | join("\n")) as $deploymentLines |
              ($deploymentEntries | length) as $deploymentCount |
              ($deploymentEntries[0].value // "" | tostring) as $firstDeploymentUrl |
              {
                text: $mention,
                attachments: [
                  {
                    color: $color,
                    title: $title,
                    fields: (
                      [
                        {title:"Systems", value:$systems, short:false},
                        {title:"Pipeline", value:$pipeline, short:true},
                        {title:"Environment", value:$envLabel, short:true},
                        {title:"Branch", value:$branch, short:true},
                        {title:"Workflow", value:$workflow, short:true},
                        {title:"Run Attempt", value:$attempt, short:true},
                        {title:"Short SHA", value:$shortSha, short:true},
                        {title:"Actor", value:$actor, short:true},
                        {title:"Compare", value:$compareUrl, short:false},
                        {title:"Run", value:$runUrl, short:false}
                      ]
                      + (if ($deploymentUrl | length) > 0 then [{title:"Deployment", value:$deploymentUrl, short:false}] else [] end)
                      + (if ($deploymentLines | length) > 0 and ($deploymentCount > 1 or ($deploymentUrl | length) == 0 or $firstDeploymentUrl != $deploymentUrl) then [{title:"Deployments", value:$deploymentLines, short:false}] else [] end)
                      + (if ($details | length) > 0 then [{title:"Details", value:$details, short:false}] else [] end)
                    ),
                    footer: ("<" + $runUrl + "|View Run>")
                  }
                ]
              }')"

      - name: Notify Discord
        if: env.HAS_DISCORD == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          retry() {
            local attempts=$1
            local delay=$2
            shift 2
            local count=1
            until "$@"; do
              if [ "$count" -ge "$attempts" ]; then
                return 1
              fi
              sleep "$delay"
              count=$((count + 1))
            done
          }

          retry 3 3 curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg mention '${{ steps.prepare.outputs.mention }}' \
              --arg title '${{ steps.prepare.outputs.emoji }} ${{ steps.prepare.outputs.title }}' \
              --arg systems '${{ inputs['system-dir'] }}' \
              --arg pipeline '${{ inputs['pipeline-type'] }}' \
              --arg branch '${{ github.ref_name }}' \
              --arg actor '${{ github.actor }}' \
              --arg workflow '${{ steps.prepare.outputs.workflow_name }}' \
              --arg attempt '${{ steps.prepare.outputs.run_attempt }}' \
              --arg shortSha '${{ steps.prepare.outputs.short_sha }}' \
              --arg compareUrl '${{ steps.prepare.outputs.compare_url }}' \
              --arg runUrl '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}' \
              --arg envLabel '${{ steps.prepare.outputs.env_emoji }} ${{ steps.prepare.outputs.env_label }}' \
              --arg deploymentUrl '${{ inputs['deployment-url'] }}' \
              --arg deploymentUrlsJson '${{ inputs['deployment-urls-json'] }}' \
              --arg details '${{ inputs['error-details'] }}' \
              --argjson envColor ${{ steps.prepare.outputs.env_color }} \
              --arg imageUrl '${{ steps.prepare.outputs.image_url }}' \
              '((try ($deploymentUrlsJson | fromjson) catch {}) | to_entries | map(select((.key | length) > 0 and ((.value | tostring) | length) > 0))) as $deploymentEntries |
              ($deploymentEntries | map("â€¢ " + .key + ": " + (.value | tostring)) | join("\n")) as $deploymentLines |
              ($deploymentEntries | length) as $deploymentCount |
              ($deploymentEntries[0].value // "" | tostring) as $firstDeploymentUrl |
              {
                content: $mention,
                embeds: [
                  {
                    title: $title,
                    color: $envColor,
                    description: (if ($details | length) > 0 then ("**Details:** " + $details) else "" end),
                    fields: (
                      [
                        {name:"Systems", value:$systems, inline:false},
                        {name:"Pipeline", value:$pipeline, inline:true},
                        {name:"Environment", value:$envLabel, inline:true},
                        {name:"Branch", value:$branch, inline:true},
                        {name:"Workflow", value:$workflow, inline:true},
                        {name:"Run Attempt", value:$attempt, inline:true},
                        {name:"Short SHA", value:$shortSha, inline:true},
                        {name:"Actor", value:$actor, inline:true},
                        {name:"Compare", value:$compareUrl, inline:false}
                      ]
                      + (if ($deploymentUrl | length) > 0 then [{name:"Deployment", value:$deploymentUrl, inline:false}] else [] end)
                      + (if ($deploymentLines | length) > 0 and ($deploymentCount > 1 or ($deploymentUrl | length) == 0 or $firstDeploymentUrl != $deploymentUrl) then [{name:"Deployments", value:$deploymentLines, inline:false}] else [] end)
                    ),
                    image: (if ($imageUrl | length) > 0 then {url:$imageUrl} else null end),
                    url: $runUrl
                  }
                ]
              }')"

